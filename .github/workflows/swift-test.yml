name: Swift Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Run tests on macOS
      run: |
        swift test --enable-code-coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: macos
        name: macos-coverage

  test-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: List available simulators
      run: |
        xcrun simctl list devices available | grep -i "iPad Pro"

    - name: Boot iOS Simulator
      run: |
        # 利用可能な iPad Pro シミュレーターを取得
        DEVICE=$(xcrun simctl list devices available | grep -i "iPad Pro" | head -1 | sed -E 's/.*\(([^)]+)\)/\1/' | xargs)
        if [ -z "$DEVICE" ]; then
          echo "iPad Pro シミュレーターが見つかりません。デフォルトのデバイスを使用します。"
          DEVICE=$(xcrun simctl list devices available | grep -i "iPad" | head -1 | sed -E 's/.*\(([^)]+)\)/\1/' | xargs)
        fi
        if [ -n "$DEVICE" ]; then
          echo "シミュレーターを起動: $DEVICE"
          xcrun simctl boot "$DEVICE" || true
        fi

    - name: Run tests on iOS Simulator
      run: |
        # 利用可能な iPad Pro シミュレーターを取得
        DEVICE_NAME=$(xcrun simctl list devices available | grep -i "iPad Pro" | head -1 | sed -E 's/^[[:space:]]*([^(]+).*/\1/' | xargs)
        DEVICE_UDID=$(xcrun simctl list devices available | grep -i "iPad Pro" | head -1 | sed -E 's/.*\(([^)]+)\)/\1/' | xargs)

        if [ -z "$DEVICE_NAME" ] || [ -z "$DEVICE_UDID" ]; then
          echo "iPad Pro シミュレーターが見つかりません。デフォルトのデバイスを使用します。"
          DEVICE_NAME=$(xcrun simctl list devices available | grep -i "iPad" | head -1 | sed -E 's/^[[:space:]]*([^(]+).*/\1/' | xargs)
          DEVICE_UDID=$(xcrun simctl list devices available | grep -i "iPad" | head -1 | sed -E 's/.*\(([^)]+)\)/\1/' | xargs)
        fi

        if [ -z "$DEVICE_NAME" ] || [ -z "$DEVICE_UDID" ]; then
          echo "エラー: 利用可能な iOS シミュレーターが見つかりません"
          xcrun simctl list devices available
          exit 1
        fi

        echo "使用するデバイス: $DEVICE_NAME ($DEVICE_UDID)"
        xcodebuild test -package . -scheme S2JSourceList -destination "platform=iOS Simulator,id=$DEVICE_UDID"
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: ios
        name: ios-coverage

  build-release:
    runs-on: macos-latest
    needs: [test-macos, test-ios]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Build Universal Binary
      run: |
        swift build -c release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: s2j-source-list-build
        path: .build/release/
