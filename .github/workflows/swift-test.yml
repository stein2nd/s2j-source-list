name: Swift Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Run tests on macOS
      run: |
        swift test --enable-code-coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: macos
        name: macos-coverage

  test-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Run tests on iOS Simulator
      run: |
        xcodebuild test -scheme S2JSourceList -destination 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation)'
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: ios
        name: ios-coverage

  build-release:
    runs-on: macos-latest
    needs: [test-macos, test-ios]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Build Universal Binary
      run: |
        swift build -c release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: s2j-source-list-build
        path: .build/release/
